\RequirePackage{filecontents}
\begin{filecontents*}{README.txt}
__________________
The asyfig package

Will Robertson 
Copyright 2008
\end{filecontents*}
%%%%%%%%%1%%%%%%%%%2%%%%%%%%%3%%%%%%%%%4%%%%%%%%%5

\begin{filecontents}{asyfig.sty}
\ProvidesPackage{asyfig}[2008/08/30 v0.1
  Commands for using asymptote figures]

\RequirePackage{graphicx,color,import}
\RequirePackage{inversepath}[2008/07/31 v0.2]
\RequirePackage{asyalign}

\newcommand\ImportIfFileExists[4]{%
  \IfFileExists{#1#2}
    {\import{#1}{#2}#3}
    {#4}}

\providecommand\asypath{}

\def\asyfig{%
  \begingroup
    \catcode`\_=11\relax % just to be sure
    \@asyfig}
\newcommand\@asyfig[2][]{%
    \inversepath*{#2}%
    \ImportIfFileExists{\asypath\ip@directpath}{\ip@lastelement_}{}{%
        \PackageWarning{asyfig}{^^J%
          \space\space "\asypath\ip@directpath\ip@lastelement" not found.^^J%
          This warning occurred}}
  \endgroup}

\end{filecontents}
%%%%%%%%%1%%%%%%%%%2%%%%%%%%%3%%%%%%%%%4%%%%%%%%%5




\begin{filecontents}{asyalign.sty}
\ProvidesPackage{asyalign}
\RequirePackage{ifpdf}

\newbox\ASYbox
\newdimen\ASYdimen

\def\ASYbase#1#2{%
  \setbox\ASYbox=\hbox{#1}%
  \ASYdimen=\ht\ASYbox
  \setbox\ASYbox=\hbox{#2}%
  \lower\ASYdimen\box\ASYbox}

\ifpdf
  \def\ASYalign(#1,#2)(#3,#4)#5#6{%
    \leavevmode
    \setbox\ASYbox=\hbox{#6}%
    \setbox\ASYbox\hbox{%
      \ASYdimen=\ht\ASYbox%
      \advance\ASYdimen by\dp\ASYbox
      \kern#3\wd\ASYbox
      \raise#4\ASYdimen\box\ASYbox}%
    \put(#1,#2){%
      \special{pdf:q #5 0 0 cm}%
      \wd\ASYbox\z@\dp\ASYbox\z@\ht\ASYbox\z@
      \box\ASYbox%
      \special{pdf:Q}%
    }}
  \let\ASYraw\@firstofone

\else
  \def\ASYalign(#1,#2)(#3,#4)#5#6{%
    \leavevmode
    \setbox\ASYbox=\hbox{#6}%
    \setbox\ASYbox\hbox{%
      \ASYdimen=\ht\ASYbox
      \advance\ASYdimen by\dp\ASYbox
      \kern#3\wd\ASYbox
      \raise#4\ASYdimen\box\ASYbox}%
    \put(#1,#2){%
      \special{%
        ps:gsave currentpoint currentpoint translate 
        [#5 0 0] concat neg exch neg exch translate}%
      \box\ASYbox
      \special{ps:currentpoint grestore moveto}%
    }}
  \def\ASYraw#1{%
    currentpoint currentpoint translate matrix currentmatrix
    100 12 div -100 12 div scale
    #1
    setmatrix neg exch neg exch translate}
\fi
\end{filecontents}
%%%%%%%%%1%%%%%%%%%2%%%%%%%%%3%%%%%%%%%4%%%%%%%%%5

\begin{filecontents}{asyprocess.sty}
\ProvidesPackage{asyprocess}
\nofiles

\RequirePackage{ifpdf,catchfile,ifplatform,color,graphicx}
\RequirePackage[active,tightpage]{preview}

\def\@par@macro{\par}

\def\asy@status{asyprocess-statusfile.txt}

\edef\@tempa{\detokenize{-comp}}
\@temptokena{\def\asy@strip@comp#1}
\expandafter\the\expandafter\@temptokena\@tempa#2\@nil{#1}
\edef\asy@compname{\expandafter\asy@strip@comp\jobname-comp\@nil}

\newcommand\ProcessAsy{%
  \immediate\write18{%
    asy -wait -inlinetex -tex \ifpdf pdf\fi latex 
      \asy@compname\space 2> \asy@status}%
  \CatchFileDef{\@tempb}{\asy@status}{}%
  \immediate\write18{\ifwindows del \else rm \fi \asy@status}     
  \ifx\@tempb\@par@macro
    \expandafter\@gobble
  \else
    \g@addto@macro\@tempb{^^J%
      ------------ ASY ERROR ------------^^J%
      -----------------------------------}%
    \expandafter\@firstofone
  \fi{%
     \nonstopmode
     \typeout{%
       -----------------------------------^^J%
       ------------ ASY ERROR ------------^^J}
     \typeout{\expandafter\strip@prefix\meaning\@tempb\@nil}
     \batchmode
     \end{document}}}

\newcommand\ShowAsy{%
  \begin{preview}
    \input{\asy@compname_}
  \end{preview}}

\AtBeginDocument{\InputIfFileExists{\asy@compname_.pre}{}{}}

\end{filecontents}


\begin{filecontents*}{test-asyfig.tex}

%\pdfoutput=0 % uncomment this to enable non-PDF mode

% this would normally be done by an external script:
\RequirePackage{ifpdf}
\immediate\write18{%
  \ifpdf pdf\fi latex 
    -shell-escape 
    -interaction=batchmode 
    -jobname=frf-comp
    \unexpanded{%
      "\RequirePackage{asyprocess}\ProcessAsy
       \documentclass{article}
       \begin{document}\ShowAsy
       \end{document}"
    }}

\documentclass[12pt,twocolumn]{article}
\usepackage[sc]{mathpazo}
\usepackage{asyfig}
\begin{document}
A boxed graphic:\\
\fbox{\sffamily\asyfig{frf}}\par
Note the font in the graphic follows the document font.
\end{document}
\end{filecontents*}

\begin{filecontents*}{frf.asy}
texpreamble("\usepackage[sc]{mathpazo}");
unitsize(10mm);
draw( (0,0){right}..{up}(3,2){down}..
      {down}(4,-2){up}..{right}(7,0) );
draw( "Resonance" , align=E, (3,2) );
draw( "Anti-resonance" , align=W, (4,-2) );
\end{filecontents*}




% Conditionally compile the documentation & generate the .ins file:
\providecommand\asyfigCompile{Y}
\makeatletter
\if\asyfigCompile N
  \expandafter\@@end
\fi




\begin{filecontents*}{asyfig.ins}
%&latex
\def\asyfigCompile{N}
\input asyfig.tex
\csname@@end\endcsname
\end{filecontents*}




\makeatletter
\documentclass{article}

\usepackage[it,medium]{titlesec}

\usepackage{bigfoot,xcolor}
\usepackage[colorlinks,linktocpage]{hyperref}

\usepackage{gmdoc}
\usepackage{gmverb}
\dekclubs
\stanzaskip=\bigskipamount 
\CodeSpacesGrey

\usepackage{tocloft,varwidth}
\setcounter{tocdepth}{1}
\def\tocwidthA{0.45}
\def\tocwidthB{0.45}
\def\cftpartfont{\scshape}
\def\cftsecfont{\small}
\cftbeforesecskip=0pt
\def\cftpartleader{}
\def\cftpartafterpnum{\cftparfillskip}
\def\cftsecleader{}
\def\cftsecafterpnum{\cftparfillskip}

\let\pkg\textsf
\def\pkgopt#1{\texttt{[#1]}}

\def\PDF{\textsc{pdf}}
\def\PS{\textsc{ps}}
\def\DVI{\textsc{dvi}}
\def\EPS{\textsc{eps}}

\usepackage{amsmath,listings}
\lstset{basicstyle=\ttfamily,columns=fullflexible}

\usepackage{asyfig}
\usepackage[T1]{fontenc}
\usepackage{microtype}
\usepackage{lmodern}
\usepackage[sc,osf]{mathpazo}
\linespread{1.1}
\frenchspacing

\GetFileInfo{asyfig.sty}
\begin{document}
{\addtocontents{toc}{\protect\begin{varwidth}[t]{\tocwidthA\linewidth}}}

\title{The \pkg{asyfig} packages}
\author{%
  \normalsize Will Robertson\footnote{\texttt{wspr81@gmail.com}}}
\date{\fileversion\qquad\filedate}

\maketitle

\begin{abstract}
This suite of packages provides an alternate method of including stand-alone Aymptote figures within \LaTeX\ documents via the \cmd\asyfig\ command.
\end{abstract}

\tableofcontents

\part{User documentation}

\section{Introduction}
Asymptote (or |asy|) is a vector graphics programming language inspired by MetaPost but based around an extended C-like language and full support for 3\textsc{d} bezier curves. Asymptote uses an auxiliary \LaTeX\ process to typeset its labels, and figures can be either generated as stand-alone graphics or in an `inline' form in which labels get placed by the main typesetting process at the figure is inserted into a document.

Support for |asy| in a \LaTeX\ document is provided by the \pkg{asymptote} package, which defines the |\begin{asy}| environment in which |asy| figures may be directly typed. In this case, the source file contains the conplete specification for the text and graphics in the document. However, for large documents it can be quite inconvenient to maintain |asy| graphics that are inline with the document source, because the whole document requires two compilations before any changes in the graphic can be visualised.

This package, \pkg{asyfig}, provides an alternative, whereby all |asy| figures are defined \emph{separately} from the source in their own individual |.asy| files. \pkg{asyfig} uses Asymptote's inline mode so that labels in the graphics are produced by the main typesetting run; this ensures consistent font and size selection of text within the graphics. In addition, each individual |.asy| graphic can be very quickly processed individually to facilitate easy maintenance and editing of the graphics.

\section{Getting started}

Load the \pkg{asyfig} package like any other. I'll discuss the workflow of the package with an illustrative example.

\paragraph{An \texttt{asy} graphic} 
First we need an example Asymptote graphic. This package is distributed with one such, |frf.asy|:
\lstinputlisting{frf.asy}
Material within |texpreamble| is \emph{not} used in the final typesetting of the labels; it is purely for the `proof' graphic that is produced before the graphic is integrated within the main document.

\paragraph{Inserting the graphic} 
After processing (see the next step), this graphic can be included in the document with the \cmd\asyfig\arg{graphic name} command. It does \emph{not} take any option arguments like a regular graphic (cf.~\cmd\includegraphics) to affect the scaling or rotation of the graphic; you are expected to produce the figure in the correct size and orientation within Asymptote.

\paragraph{Processing the graphic}
But before the graphic can be inserted it must be processed (in the future I might make this an automatic option within the package).  The processing is performed by the \pkg{asyprocess} package in an auxiliary \LaTeX\ execution. Here is the shell script, called (say) |asyprocess|, that I use to do this: (so figure processing would be `|asyprocess frf|' in this example)
\begin{lstlisting}
#!/bin/sh
pdflatex -shell-escape -interaction=batchmode -jobname=$1-comp 
  "\RequirePackage{asyprocess}\ProcessAsy
   \documentclass{article}\begin{document}\ShowAsy\end{document}"
\end{lstlisting}
Simply change |pdflatex| to |latex| to have \EPS\ graphics produced by Asymptote.


\section{Package information}
The most recent publicly released version of \pkg{asyfig} will be available at \textsc{CTAN}:\\
\centerline{\url{http://tug.ctan.org/pkg/asyfig/}}\\ 
Historical and developmental versions are available at GitHub:\\ \centerline{\url{http://github.com/wspr/asyfig/}}\\
While general feedback at \url{wspr81@gmail.com} is welcomed, specific bugs should be reported through the bug tracker at FogBugz: \url{https://wspr.fogbugz.com/} (click `\textsc{tasks}: Enter a New Case').

This package is freely modifiable and distributable under the terms and conditions of the \LaTeX\ Project Public Licence, version 1.3c or greater (your choice). The latest version of
this license is available at: \url{http://www.latex-project.org/lppl.txt}. This work is maintained by \textsc{Will Robertson}.

{\addtocontents{toc}{\protect\end{varwidth}\protect\hfill}}
{\addtocontents{toc}{\protect\begin{varwidth}[t]{\protect\tocwidthB\protect\linewidth}}}
\clearpage
\parindent=0pt
\part{Implementation}
\section{The asyfig package}
\DocInput{asyfig.sty}
\section{The asyalign package}
\DocInput{asyalign.sty}
\section{The asyprocess package}
\DocInput{asyprocess.sty}

{\addtocontents{toc}{\protect\end{varwidth}}}
\end{document}
